WEBVTT

1
00:00:00.150 --> 00:00:02.340
<v ->So, let's talk about CloudFormation rollbacks.</v>

2
00:00:02.340 --> 00:00:05.520
And they're very important to understand at the exam.

3
00:00:05.520 --> 00:00:07.320
So, if you create a stack

4
00:00:07.320 --> 00:00:09.450
and the stack creation fails,

5
00:00:09.450 --> 00:00:11.070
you have two options.

6
00:00:11.070 --> 00:00:13.320
The first one is the default option,

7
00:00:13.320 --> 00:00:15.507
which is that everything rolls back

8
00:00:15.507 --> 00:00:17.730
and that means gets deleted.

9
00:00:17.730 --> 00:00:21.420
And you can look at the log of your CloudFormation create

10
00:00:21.420 --> 00:00:23.580
to understand what happened and why it failed,

11
00:00:23.580 --> 00:00:26.400
but you cannot look at your resources.

12
00:00:26.400 --> 00:00:28.830
But if one of these resources has a problem

13
00:00:28.830 --> 00:00:30.120
and you want to keep it,

14
00:00:30.120 --> 00:00:32.340
you have the option to disable the rollback

15
00:00:32.340 --> 00:00:35.373
to troubleshoot what happened during your stack creation.

16
00:00:36.270 --> 00:00:39.540
If it is a problem with stack updates,

17
00:00:39.540 --> 00:00:41.610
then automatically, by default,

18
00:00:41.610 --> 00:00:44.250
the stack is automatically going to roll back

19
00:00:44.250 --> 00:00:47.130
to the last previous known working states,

20
00:00:47.130 --> 00:00:50.670
again, deleting anything that was newly created.

21
00:00:50.670 --> 00:00:53.310
And again, you can look in the log to see what happened,

22
00:00:53.310 --> 00:00:55.590
and the error messages.

23
00:00:55.590 --> 00:00:57.450
Now, in case of a rollback failure,

24
00:00:57.450 --> 00:00:59.640
so that means that there's a stack update,

25
00:00:59.640 --> 00:01:00.510
it rolls back,

26
00:01:00.510 --> 00:01:03.750
and during the rollback, there is a failure.

27
00:01:03.750 --> 00:01:06.660
Then, this is a problem with your stack

28
00:01:06.660 --> 00:01:10.380
and you probably had resources that were manually changed.

29
00:01:10.380 --> 00:01:11.280
In that case,

30
00:01:11.280 --> 00:01:14.670
you need to go and fix these resources manually.

31
00:01:14.670 --> 00:01:16.200
And then, through the console,

32
00:01:16.200 --> 00:01:17.730
or through the API,

33
00:01:17.730 --> 00:01:20.330
you can issue what's called a ContinueUpdateRollback

34
00:01:21.330 --> 00:01:25.020
to tell CloudFormation to try rolling back again.

35
00:01:25.020 --> 00:01:26.970
So, either you do it from the console

36
00:01:26.970 --> 00:01:27.930
or an API call

37
00:01:27.930 --> 00:01:29.100
or from the CLI

38
00:01:29.100 --> 00:01:32.163
using the ContinueUpdateRollback API call.

39
00:01:33.450 --> 00:01:35.100
Okay. So, let's practice failures.

40
00:01:35.100 --> 00:01:36.990
So, let's create a stack,

41
00:01:36.990 --> 00:01:38.490
and we'll upload a template file.

42
00:01:38.490 --> 00:01:39.750
And the file I'm going to upload

43
00:01:39.750 --> 00:01:42.120
is called trigger-failure.yaml,

44
00:01:42.120 --> 00:01:43.560
the number two.

45
00:01:43.560 --> 00:01:45.360
So, why is this file problematic?

46
00:01:45.360 --> 00:01:48.330
Well, if you go into trigger-failure.yaml,

47
00:01:48.330 --> 00:01:51.000
you look at the image ID of my EC2 instance.

48
00:01:51.000 --> 00:01:52.920
It is an image ID that does not exist,

49
00:01:52.920 --> 00:01:55.890
so therefore, it's going to create a failure.

50
00:01:55.890 --> 00:01:56.940
So, let's click on Next.

51
00:01:56.940 --> 00:02:00.150
And I'll call this one TriggerCreationFailure.

52
00:02:02.280 --> 00:02:03.540
Click on Next.

53
00:02:03.540 --> 00:02:05.640
And here, under Stack failure options,

54
00:02:05.640 --> 00:02:07.140
we have two options.

55
00:02:07.140 --> 00:02:09.540
Number one is to roll back all stack resources.

56
00:02:09.540 --> 00:02:11.490
That means that they're going to be rolled back

57
00:02:11.490 --> 00:02:14.130
to the previous known stable states,

58
00:02:14.130 --> 00:02:17.700
or we can preserve successfully provisioned resources.

59
00:02:17.700 --> 00:02:20.250
And this will keep the successfully provisioned resources

60
00:02:20.250 --> 00:02:22.050
and roll back any failed resources

61
00:02:22.050 --> 00:02:24.330
to the last known stable states.

62
00:02:24.330 --> 00:02:27.750
So, if we do this, which is the non default option,

63
00:02:27.750 --> 00:02:30.360
and then we click on Next,

64
00:02:30.360 --> 00:02:32.223
and then Submit,

65
00:02:33.480 --> 00:02:34.470
as you can see,

66
00:02:34.470 --> 00:02:37.620
we generate an SSH security group

67
00:02:37.620 --> 00:02:41.550
and we generate a server security group.

68
00:02:41.550 --> 00:02:42.840
And so, as you can see,

69
00:02:42.840 --> 00:02:44.280
I need to-

70
00:02:44.280 --> 00:02:45.240
First of all,

71
00:02:45.240 --> 00:02:46.230
there's one problem

72
00:02:46.230 --> 00:02:48.780
that I didn't provide the group description.

73
00:02:48.780 --> 00:02:51.480
So, it's a good example of the failure of this.

74
00:02:51.480 --> 00:02:52.430
So, as you can see,

75
00:02:53.550 --> 00:02:56.460
even though my server security group

76
00:02:56.460 --> 00:02:58.320
was not able to be created,

77
00:02:58.320 --> 00:03:00.060
my SSH security group

78
00:03:00.060 --> 00:03:01.620
was able to be created.

79
00:03:01.620 --> 00:03:03.360
And if I go into Resources,

80
00:03:03.360 --> 00:03:05.070
well one is still being kept.

81
00:03:05.070 --> 00:03:09.780
Whereas, if you had a creation and by default it would fail,

82
00:03:09.780 --> 00:03:11.490
it would delete everything.

83
00:03:11.490 --> 00:03:12.630
So, this could be the occasion

84
00:03:12.630 --> 00:03:14.550
to just troubleshoot if you needed to.

85
00:03:14.550 --> 00:03:18.750
But of course, because this leaves some remainders,

86
00:03:18.750 --> 00:03:21.837
you need to absolutely delete the stack to get rid of it.

87
00:03:21.837 --> 00:03:24.240
So, you cannot update the stack and fix things.

88
00:03:24.240 --> 00:03:26.220
So, we will delete it.

89
00:03:26.220 --> 00:03:27.750
And now, it's gone.

90
00:03:27.750 --> 00:03:29.940
So, this is showing you the option

91
00:03:29.940 --> 00:03:31.110
of what it is

92
00:03:31.110 --> 00:03:33.270
when there is a create failure,

93
00:03:33.270 --> 00:03:34.650
and you can do the exact same thing.

94
00:03:34.650 --> 00:03:36.780
So, you can create a stack right now.

95
00:03:36.780 --> 00:03:38.160
I'll create a stack

96
00:03:38.160 --> 00:03:39.870
based on the correct template

97
00:03:39.870 --> 00:03:42.840
called just-ec2.yaml.

98
00:03:42.840 --> 00:03:43.673
And I'll call it

99
00:03:45.342 --> 00:03:48.330
FailureOnUpdate.

100
00:03:48.330 --> 00:03:49.980
So, right now, we're good.

101
00:03:49.980 --> 00:03:51.420
We know that this is going to work

102
00:03:51.420 --> 00:03:54.300
because, well, this is the template we've used from before.

103
00:03:54.300 --> 00:03:56.790
So, let's wait for things to be created.

104
00:03:56.790 --> 00:03:58.050
And as we can see, we're good.

105
00:03:58.050 --> 00:03:59.340
So, I'm going to update my stack.

106
00:03:59.340 --> 00:04:00.390
And if you don't see this button,

107
00:04:00.390 --> 00:04:01.860
just refresh your page.

108
00:04:01.860 --> 00:04:02.730
So, update my stack,

109
00:04:02.730 --> 00:04:05.010
but this time, I will replace the template

110
00:04:05.010 --> 00:04:07.950
with the template file named trigger failure.

111
00:04:07.950 --> 00:04:10.680
So, this time we'll have a group description

112
00:04:10.680 --> 00:04:12.150
called hello.

113
00:04:12.150 --> 00:04:13.140
Next...

114
00:04:13.140 --> 00:04:14.430
And here we have, again, the option

115
00:04:14.430 --> 00:04:16.080
to roll back all stack resources

116
00:04:16.080 --> 00:04:20.370
or to preserve successfully provisioned resources.

117
00:04:20.370 --> 00:04:22.920
So, where now we say roll back everything

118
00:04:22.920 --> 00:04:23.753
and see what happens

119
00:04:23.753 --> 00:04:26.400
and then we'll do the second option right after.

120
00:04:26.400 --> 00:04:28.770
So, let's click on Next.

121
00:04:28.770 --> 00:04:30.393
And then click on Submit.

122
00:04:31.260 --> 00:04:33.900
So, this is going to create a few security groups,

123
00:04:33.900 --> 00:04:36.960
and then, it's going to trigger a rollback.

124
00:04:36.960 --> 00:04:40.320
So, my security groups right now are being created.

125
00:04:40.320 --> 00:04:41.283
Now they're done.

126
00:04:42.360 --> 00:04:43.193
And as you can see,

127
00:04:43.193 --> 00:04:45.630
the instance get created,

128
00:04:45.630 --> 00:04:46.950
but then there was an update failed

129
00:04:46.950 --> 00:04:50.850
because, well, the invalid AMI was not found.

130
00:04:50.850 --> 00:04:52.740
So therefore, what's going to happen?

131
00:04:52.740 --> 00:04:56.220
Well, because we have specified everything to roll back,

132
00:04:56.220 --> 00:04:58.140
then everything is going to roll back

133
00:04:58.140 --> 00:04:59.820
based on the last known state.

134
00:04:59.820 --> 00:05:02.980
And so, that means that my server security group

135
00:05:04.035 --> 00:05:06.120
and SSH security groups

136
00:05:06.120 --> 00:05:07.680
should disappear.

137
00:05:07.680 --> 00:05:10.023
So, let's wait for these events to happen.

138
00:05:11.190 --> 00:05:12.600
And as you can see right now,

139
00:05:12.600 --> 00:05:15.450
my SSH security group and server security group

140
00:05:15.450 --> 00:05:16.533
get deleted.

141
00:05:17.430 --> 00:05:18.960
And similarly, as an exercise,

142
00:05:18.960 --> 00:05:20.940
if you update the stack,

143
00:05:20.940 --> 00:05:24.390
but this time you choose, again, the trigger failure

144
00:05:24.390 --> 00:05:27.513
and we just enter description again,

145
00:05:28.710 --> 00:05:30.120
and then the stack failure option,

146
00:05:30.120 --> 00:05:33.240
we just say preserve successfully provisioned resources,

147
00:05:33.240 --> 00:05:34.110
then you know what happens.

148
00:05:34.110 --> 00:05:35.550
You can try it out on your own.

149
00:05:35.550 --> 00:05:38.610
This would create SSH and server security groups,

150
00:05:38.610 --> 00:05:40.380
but it would not roll them back

151
00:05:40.380 --> 00:05:43.170
in case there is a rollback happening,

152
00:05:43.170 --> 00:05:44.400
a stack failure.

153
00:05:44.400 --> 00:05:46.170
So, this is up to you to choose what you want,

154
00:05:46.170 --> 00:05:49.920
but both the behaviors can be desirable

155
00:05:49.920 --> 00:05:51.840
based on what you're trying to do.

156
00:05:51.840 --> 00:05:52.673
So, when you're done,

157
00:05:52.673 --> 00:05:54.120
please go ahead and delete the stack

158
00:05:54.120 --> 00:05:55.140
and you'll be good.

159
00:05:55.140 --> 00:05:55.980
All right. That's it.

160
00:05:55.980 --> 00:05:57.120
I hope you liked it.

161
00:05:57.120 --> 00:05:59.070
And I will see you in the next lecture.

