WEBVTT

1
00:00:00.380 --> 00:00:01.910
<v Stephane>Okay, so a quick lecture</v>

2
00:00:01.910 --> 00:00:03.230
on Secrets Manager monitoring

3
00:00:03.230 --> 00:00:05.000
'cause there are two things you need to know.

4
00:00:05.000 --> 00:00:07.170
The first one is that CloudTrail does capture API calls

5
00:00:07.170 --> 00:00:10.080
made to the Secrets Manager API, but also CloudTrail,

6
00:00:10.080 --> 00:00:13.450
and this is very unique, will capture other related events

7
00:00:13.450 --> 00:00:15.550
that might have a security or compliance impact

8
00:00:15.550 --> 00:00:17.150
on your accounts or might help you

9
00:00:17.150 --> 00:00:18.800
troubleshoot operational problems.

10
00:00:18.800 --> 00:00:22.610
And these events are called non-API service events,

11
00:00:22.610 --> 00:00:24.340
and they're specific to Secrets Manager.

12
00:00:24.340 --> 00:00:26.816
And, so, as you can see, CloudTrail will receive

13
00:00:26.816 --> 00:00:30.820
both API calls and non-API events in the CloudTrail.

14
00:00:30.820 --> 00:00:33.580
So what are these non-API service events?

15
00:00:33.580 --> 00:00:36.152
Well, the first one will be a RotationStarted event.

16
00:00:36.152 --> 00:00:37.237
So whenever Rotation starts,

17
00:00:37.237 --> 00:00:39.160
it will be registered in CloudTrail.

18
00:00:39.160 --> 00:00:41.220
RotationSucceeded event, that makes sense.

19
00:00:41.220 --> 00:00:44.029
RotatonFailed event, this is very important.

20
00:00:44.029 --> 00:00:46.340
RotationAbandoned event, this is when there is

21
00:00:46.340 --> 00:00:48.520
a manual change to a target secret

22
00:00:48.520 --> 00:00:50.180
instead of an automated Rotation.

23
00:00:50.180 --> 00:00:52.337
This will also be registered in CloudTrail.

24
00:00:52.337 --> 00:00:54.920
StartSecretVersionDelete events,

25
00:00:54.920 --> 00:00:57.210
CancelSecretVersionDelete events

26
00:00:57.210 --> 00:01:00.590
and EndSecretVersionDelete events.

27
00:01:00.590 --> 00:01:04.300
So, all these things, the idea to have is that whenever

28
00:01:04.300 --> 00:01:06.020
something happens, within the Secret Manager,

29
00:01:06.020 --> 00:01:07.160
it will be recorded in CloudTrail,

30
00:01:07.160 --> 00:01:09.010
and these are very, very important events.

31
00:01:09.010 --> 00:01:10.990
And we can build some, sort of, alerting (indistinct),

32
00:01:10.990 --> 00:01:12.630
so very important one is, for example,

33
00:01:12.630 --> 00:01:14.130
if the Rotation has failed.

34
00:01:14.130 --> 00:01:17.340
So we can combine with CloudWatch Logs and CloudWatch alarms

35
00:01:17.340 --> 00:01:19.910
automations to create, for example,

36
00:01:19.910 --> 00:01:22.770
an alert in case a RotationFailed event happens.

37
00:01:22.770 --> 00:01:23.790
So how do we do this?

38
00:01:23.790 --> 00:01:26.890
Well, CloudTrail stores it's logs in CloudWatch Logs, right,

39
00:01:26.890 --> 00:01:29.920
and on top of CloudWatch Logs we can create a metric filter,

40
00:01:29.920 --> 00:01:33.630
and this metric filter can have us create a metric

41
00:01:33.630 --> 00:01:35.930
to alert for these RotationFailed events,

42
00:01:35.930 --> 00:01:39.070
appearance, for example, and then it will be sent

43
00:01:39.070 --> 00:01:41.500
into a CloudWatch alarm that will send a notification

44
00:01:41.500 --> 00:01:45.570
to SNS whenever we reach that metric threshold.

45
00:01:45.570 --> 00:01:47.590
So this is quite important and quite good to know.

46
00:01:47.590 --> 00:01:48.629
So that's one way of being aware

47
00:01:48.629 --> 00:01:50.130
that there has been an issue,

48
00:01:50.130 --> 00:01:53.440
or something very important happening, with Secrets Manager,

49
00:01:53.440 --> 00:01:55.180
but the other way to do it

50
00:01:55.180 --> 00:01:57.180
is to troubleshoot the Rotation itself.

51
00:01:57.180 --> 00:01:58.940
So let's say that there is a Rotation fail,

52
00:01:58.940 --> 00:02:00.889
so Secrets Manager will store, as we said,

53
00:02:00.889 --> 00:02:03.980
all the API calls and non-API events in CloudTrail.

54
00:02:03.980 --> 00:02:06.670
And Secrets Manager, upon a Rotation of secrets,

55
00:02:06.670 --> 00:02:08.640
is going to try to invoke a Lambda function

56
00:02:08.640 --> 00:02:11.000
that will be performing the Rotation itself.

57
00:02:11.000 --> 00:02:13.660
Now this Lambda function, for example, has a target

58
00:02:13.660 --> 00:02:16.420
to change the password on an Amazon RDS database,

59
00:02:16.420 --> 00:02:18.180
but let's assume that there is an error

60
00:02:18.180 --> 00:02:19.940
and this Rotation did not work.

61
00:02:19.940 --> 00:02:21.270
We don't know why, right.

62
00:02:21.270 --> 00:02:23.800
Well, if you wanted to debug what's happening,

63
00:02:23.800 --> 00:02:24.820
where would we look?

64
00:02:24.820 --> 00:02:28.580
We would look in CloudTrail or in the Lambda function logs,

65
00:02:28.580 --> 00:02:30.370
and, obviously, the better place to look at

66
00:02:30.370 --> 00:02:32.350
is the Lambda function logs because it contains

67
00:02:32.350 --> 00:02:34.470
the actual code execution, and will give you

68
00:02:34.470 --> 00:02:36.910
a proper error message as to what happened

69
00:02:36.910 --> 00:02:38.160
during an execution.

70
00:02:38.160 --> 00:02:39.630
So all these logs, in CloudWatch Logs,

71
00:02:39.630 --> 00:02:41.890
are really, really helpful, and, as an administrator,

72
00:02:41.890 --> 00:02:45.630
this is where you will debug your issues with Rotation,

73
00:02:45.630 --> 00:02:47.800
but to be alerted that the Rotation did fail

74
00:02:47.800 --> 00:02:50.840
we could look at either CloudTrail or also have alerts

75
00:02:50.840 --> 00:02:53.460
on the Lambda function failure rates, okay.

76
00:02:53.460 --> 00:02:54.810
So that's it for Secrets Manager,

77
00:02:54.810 --> 00:02:56.660
troubleshooting and monitoring.

78
00:02:56.660 --> 00:02:59.583
I hope you liked it, and I will see you in the next lecture.

